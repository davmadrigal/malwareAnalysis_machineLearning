# Bash script to download Malware Bazaar based on tag

# Define tag and number of samples to download
TAG=ransomware
DOWNLOAD_LIMIT=1000
# Name of the output file
outfile="localHashFile.txt"
outPreProcessedFile="hashDate.hash"

echo $counter
# Download hash values from tag, save the SHA256 hashes
curl -v -XPOST -d "query=get_taginfo&tag=${TAG}&limit=${DOWNLOAD_LIMIT}" https://mb-api.abuse.ch/api/v1/ | grep -E 'sha256_hash|first_seen' | awk '{print $2}' > ${TAG}.raw 

sed 's/\"//g' ${TAG}.raw > ${TAG}aux.raw
sed 's/\,//g' ${TAG}aux.raw > ${TAG}aux2.raw
rm ${TAG}aux.raw

# Create the hash file from the raw file
mv ${TAG}aux2.raw ${TAG}.hash
rm ${TAG}.raw

# process the file. hash, date
while IFS= read -r h && IFS= read -r h2; do
echo $h,$h2 >> $outPreProcessedFile
done < ${TAG}.hash

# read line, pick up first one with cut, check if needs to be added to the file

while read h; do
malwareHash=`echo ${h} | cut -d',' -f1`
dateHash=`echo ${h} | cut -d',' -f2`

    # was the file already downloaded?
    if grep -iq "${malwareHash}" $outfile; then
        echo -e "\e[32m######### EXISTS!!The file ${malwareHash} is in our local database. Skip and continue\e[0m"
	continue
    else
	# Create a new name with the counter
        new_name="sample${counter}"

	#get malware info using the hash
	json_response=`curl -XPOST -d "query=get_info&hash=${malwareHash}" https://mb-api.abuse.ch/api/v1/`
    	sleep 1

	#if echo "$json_response" | grep -iq 'ransom\|ransomware'; then
	if echo "$json_response" | grep -iq 'exe'; then
    		#echo "The JSON response contains the words 'ransom' or 'ransomware'"
    		echo "The JSON response contains the words 'exe''"


		# Ransonware file. download it
    		curl -XPOST -d "query=get_file&sha256_hash=${malwareHash}" -o ${new_name} https://mb-api.abuse.ch/api/v1/
        
		echo "Fichero $new_name descargado"
        	# Unarchive the malware samples
        	7z e ${new_name} -p"infected"
        	rm ${new_name}
        	cp "/home/daleal/Descargas/malwaresFromBazarMalware/${malwareHash}.exe" "/home/daleal/Descargas/malwaresFromBazarMalware/malwares/${new_name}.exe"
        	rm "${malwareHash}.exe"
		if [ $? -ne 0 ]; then
        		echo -e "\e[31m#########ERROR EXE: There is no .exe, Try with .dll \e[0m"
			cp "/home/daleal/Descargas/malwaresFromBazarMalware/${malwareHash}.dll" "/home/daleal/Descargas/malwaresFromBazarMalware/malwares/${new_name}.dll"
                	rm "${malwareHash}.dll"

			if [ $? -ne 0 ]; then
        			echo -e "\e[31m#########ERROR DLL: No .dll. Skip execution. Manual Fix\e[0m"
				continue
			else
			# else add file and increment the counter. dll file
				echo $new_name,$malwareHash,$dateHash >> $outfile
                		let counter++
				continue
			fi
		else
			# else add file and increment counter. Exe file
			echo $new_name,$malwareHash,$dateHash >> $outfile
                	let counter++
			continue
		fi
		
	fi
    fi
done < $outPreProcessedFile

	
rm ${TAG}.hash
rm $outPreProcessedFile
